FROM node:latest as node

ARG REACT_APP_TMETRIC_TOKEN
ARG REACT_APP_CLIENT_ID
ARG REACT_APP_CLIENT_SECRET
ARG REACT_APP_BACKEND_URL
ARG STAGE_ENV

ENV REACT_APP_TMETRIC_TOKEN ${REACT_APP_TMETRIC_TOKEN:-''}
ENV REACT_APP_CLIENT_ID ${REACT_APP_CLIENT_ID:-''}
ENV REACT_APP_CLIENT_SECRET ${REACT_APP_CLIENT_SECRET:-''}
ENV REACT_APP_BACKEND_URL ${REACT_APP_BACKEND_URL:-''}
ENV STAGE_ENV ${STAGE_ENV:-0}

WORKDIR /build
COPY . /build
RUN printf "REACT_APP_TMETRIC_TOKEN=${REACT_APP_TMETRIC_TOKEN}\nREACT_APP_CLIENT_ID=${REACT_APP_CLIENT_ID}\nREACT_APP_CLIENT_SECRET=${REACT_APP_CLIENT_SECRET}\nREACT_APP_BACKEND_URL=${REACT_APP_BACKEND_URL}\nSTAGE_ENV=${STAGE_ENV}" > .env

RUN yarn && yarn prod

FROM nginx:alpine as nginx

WORKDIR /var/www/data

COPY --from=node /build/dist /var/www/data
COPY docker/default.nginx /etc/nginx/conf.d/default.conf
